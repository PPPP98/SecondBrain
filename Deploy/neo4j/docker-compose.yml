services:
  neo4j:
    image: neo4j:5.25
    container_name: neo4j
    restart: unless-stopped

    ports:
      - "7474"

    environment:
      # 관리자 계정 설정 (neo4j / 비밀번호)
      NEO4J_AUTH: "neo4j/${NEO4J_PASSWORD}"
      
      # 외부 접속 허용
      NEO4J_server_default__listen__address: "0.0.0.0"
      NEO4J_server_default__advertised__address: "brainsecond.site"
      
      # APOC 관련 (파일 import/export 허용)
      NEO4J_apoc_export_file_enabled: "true"
      NEO4J_apoc_import_file_enabled: "true"
      NEO4J_apoc_import_file_use__neo4j__config: "true"

      # 메모리 튜닝(EC2가 16GB가 아니라면 적당히 낮춰)
      NEO4J_server_memory_heap_initial__size: "1g"
      NEO4J_server_memory_heap_max__size: "1g"
      NEO4J_server_memory_pagecache_size: "1g"

      # 필요한 플러그인만 열고 싶으면 아래처럼
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"

      NEO4J_dbms_ssl_policy_bolt_enabled: "true"
      NEO4J_dbms_ssl_policy_bolt_base__directory: "/ssl/bolt"
      NEO4J_dbms_ssl_policy_bolt_private__key: "private.key"
      NEO4J_dbms_ssl_policy_bolt_public__certificate: "public.crt"
      NEO4J_dbms_connector_bolt_tls__level: "REQUIRED"

    volumes:
      - neo4j_main_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
      - /opt/neo4j-certs:/ssl:ro

    mem_limit: 2g
    memswap_limit: 2g
    cpus: "1.0"

    networks:
      - e107_net

networks:
  e107_net:
    external: true

volumes:
  neo4j_main_data:
    external: true
  neo4j_logs:
    external: true
  neo4j_import:
    external: true
  neo4j_plugins:
    external: true
