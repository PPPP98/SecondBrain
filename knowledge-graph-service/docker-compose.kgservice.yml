services:
  # Neo4j 그래프 데이터베이스
  neo4j:
    image: neo4j:5.26.0
    container_name: kg-neo4j
    environment:
      - NEO4J_AUTH=${NEO4J_USER}/${NEO4J_PASSWORD}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    ports:
      - "${NEO4J_HTTP_PORT}:7474"   # HTTP
      - "${NEO4J_BOLT_PORT}:7687"   # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - kg-network
    restart: unless-stopped

  # FastAPI Knowledge Graph Service
  kg-service:
    build:
      context: .
      dockerfile: Dockerfile.kgservice.dev
    container_name: kg-service-app
    ports:
      - "${KG_SERVICE_PORT}:8000"
    env_file:
      - .env
    environment:
      # Docker 컨테이너 간 통신을 위해 Neo4j URI 오버라이드
      NEO4J_URI: bolt://neo4j:7687
    depends_on:
      - neo4j
    volumes:
      # 개발 시 코드 변경 시 자동 reload를 위한 볼륨 마운트
      - .:/app
      - /app/__pycache__
      - /app/.pytest_cache
    networks:
      - kg-network
    # Neo4j 준비 대기 후 시작
    command: sh -c "while ! nc -z neo4j 7687; do echo 'Waiting for Neo4j...'; sleep 2; done && echo 'Neo4j is ready!' && uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
    restart: unless-stopped

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local

networks:
  kg-network:
    driver: bridge
