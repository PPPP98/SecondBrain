# TIL: Git 히스토리에서 민감정보 완전 제거하기

**날짜**: 2025-10-29
**작성자**: 로예성
**태그**: `Git`, `Security`, `Troubleshooting`, `git-reset`, `force-push`

---

## 📌 문제 상황

커밋 `8775b6c5c357f684c930e515cec1850232b4d0c9`에 PostgreSQL과 Redis의 **평문 패스워드**가 포함된 `application.yml` 파일이 업로드되어 원격 저장소(GitLab)에 푸시되었다.

```yaml
# Backend/SecondBrain/src/main/resources/application.yml
spring:
  datasource:
    password: 이패스워드는노출되었습니다  # ⚠️ 노출!
  data:
    redis:
      password: 이패스워드는노출되었습니다  # ⚠️ 노출!
```

### 문제의 심각성
- 🔴 **CRITICAL**: 평문 패스워드가 Git 히스토리에 영구 기록됨
- 🔴 원격 저장소에 이미 푸시되어 팀원들도 접근 가능
- 🔴 단순히 파일을 삭제해도 히스토리에는 남아있음

---

## 🎯 목표

1. 커밋 `8775b6c` 및 **이후의 모든 커밋**을 Git 히스토리에서 **완전히 제거**
2. 해당 커밋의 유용한 변경사항(`build.gradle`, `SecondBrainApplication.java`)은 **백업 후 재적용**
3. Git graph와 히스토리에서 흔적이 남지 않도록 완벽하게 정리

---

## 🔍 시도했던 방법들과 실패 경험

### 시도 1: git-filter-repo로 파일만 제거 ❌

**시도한 방법**:
```bash
git filter-repo --path application.yml --invert-paths --force
```

**문제점**:
- 파일은 제거되었지만 **커밋 자체는 남아있음**
- 커밋 메시지 "[BE] chore: Redis, PostgreSQL 연결 완료"가 여전히 존재
- 커밋 해시만 변경되고(`8775b6c` → `c096589`) 실질적으로는 히스토리에 남음

**교훈**: `git-filter-repo`는 특정 파일을 히스토리에서 제거하지만, 커밋 전체를 삭제하지는 않는다.

---

### 시도 2: git-filter-repo 실행 중 의도치 않은 파일 삭제 ❌

**시도한 방법**:
```bash
git filter-repo --path Backend/SecondBrain/src/main/resources/application.yml --invert-paths --force
```

**문제점**:
- `Backend/` (대문자)와 `backend/` (소문자) 경로를 혼동
- 필터링 과정에서 예상치 못한 파일들(`build.gradle`, wrapper 파일 등)이 함께 삭제됨
- 최신 커밋("중복 파일 제거")에서 프로젝트 파일들이 모두 사라짐

**해결 방법**:
```bash
# 원격 저장소에서 다시 복원
git fetch origin
git reset --hard origin/develop
```

**교훈**: `git-filter-repo`는 강력하지만 예측하기 어려운 부작용이 있을 수 있다. 작업 전 **반드시 전체 백업**이 필요하다.

---

## ✅ 최종 해결 방법

### 접근 전략
`git-filter-repo` 대신 **`git reset --hard`**를 사용하여 커밋을 **완전히 삭제**하고, 필요한 변경사항만 새 커밋으로 재적용하는 방식으로 변경.

---

## 🛠️ 상세 해결 과정

### 1단계: 전체 백업 생성

```bash
# 백업 디렉토리 생성
BACKUP_DIR="$HOME/git-cleanup-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"

# Git 번들로 전체 저장소 백업
git bundle create "$BACKUP_DIR/repo-full-backup.bundle" --all

# 결과: 401KB 번들 파일 생성
```

**중요**: 모든 Git 히스토리 수정 작업은 **복구 불가능**하므로 백업은 필수!

---

### 2단계: 삭제할 커밋과 보존할 변경사항 분석

```bash
# 삭제 대상 커밋 확인
git log --oneline 8775b6c^..HEAD
# 결과: 8개 커밋 (8775b6c 포함)

# 8775b6c의 변경사항 확인
git show 8775b6c --name-status
```

**8775b6c 커밋의 내용**:
- ✅ `backend/secondBrain/build.gradle` - **보존 필요** (의존성 재정렬)
- ✅ `backend/secondBrain/src/main/java/uknowklp/secondBrain/SecondBrainApplication.java` - **보존 필요** (패키지명 수정)
- ❌ `Backend/SecondBrain/src/main/resources/application.yml` - **제거 대상** (민감정보)
- ❌ `backend/secondBrain/src/main/resources/application.yaml` - **제거 대상** (삭제된 파일)

---

### 3단계: 보존할 변경사항 백업

```bash
# build.gradle 변경사항을 패치 파일로 백업
git diff 8775b6c^..8775b6c -- backend/secondBrain/build.gradle > "$BACKUP_DIR/build.gradle.patch"

# SecondBrainApplication.java 변경사항 백업
git diff 8775b6c^..8775b6c -- backend/secondBrain/src/main/java/uknowklp/secondBrain/SecondBrainApplication.java > "$BACKUP_DIR/SecondBrainApplication.patch"

# 삭제될 커밋 목록 저장
git log 8775b6c^..HEAD --oneline > "$BACKUP_DIR/deleted-commits.txt"
```

---

### 4단계: 원본 상태로 복원 (백업 복원)

실수로 잘못된 작업을 했을 경우를 대비해 원격 저장소에서 완전히 복원:

```bash
# 원격 저장소 설정 복원
git remote rename origin-backup origin 2>/dev/null || echo "이미 복원됨"

# 원격의 최신 상태로 완전 복원
git fetch origin
git reset --hard origin/develop
```

---

### 5단계: 커밋 완전 삭제

```bash
# 8775b6c 직전 커밋(cd23dca)으로 되돌리기
git reset --hard cd23dca

# 결과 확인
git log --oneline --graph -10
# ✅ 8775b6c 및 이후 커밋이 모두 사라짐
```

**핵심 포인트**:
- `git reset --hard <커밋>`은 HEAD를 해당 커밋으로 완전히 이동
- 이후의 모든 커밋이 히스토리에서 제거됨 (로컬 브랜치 기준)

---

### 6단계: Git 객체 정리

```bash
# unreachable 객체 정리
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 원격 refs 제거
rm -rf .git/refs/remotes/*
```

**주의**: 이 시점에서는 로컬 Git 객체 저장소에 아직 8775b6c가 남아있을 수 있지만, Force push 후에는 원격에서 완전히 사라진다.

---

### 7단계: 백업한 변경사항 재적용

```bash
# 패치 파일 적용
git apply "$BACKUP_DIR/build.gradle.patch"
git apply "$BACKUP_DIR/SecondBrainApplication.patch"

# 변경사항 확인
git status
# modified:   backend/secondBrain/build.gradle
# modified:   backend/secondBrain/src/main/java/uknowklp/secondBrain/SecondBrainApplication.java

# 스테이징 및 커밋
git add backend/secondBrain/build.gradle backend/secondBrain/src/main/java/uknowklp/secondBrain/SecondBrainApplication.java
git commit -m "[BE] chore: 의존성 재정렬 및 패키지명 수정

- build.gradle 의존성 그룹화 (Database, Auth)
- SecondBrainApplication.java 패키지명 대소문자 수정"
```

**결과**:
```
[develop 4c1b6fe] [BE] chore: 의존성 재정렬 및 패키지명 수정
 2 files changed, 7 insertions(+), 2 deletions(-)
```

---

### 8단계: Force Push로 원격 저장소 업데이트

#### 8-1. 브랜치 보호 설정 변경

GitLab에서 Force Push 허용:
1. **Settings** → **Repository** → **Protected branches**
2. `develop` 브랜치 설정에서 **"Allowed to force push"** 활성화

#### 8-2. Force Push 실행

```bash
git push origin develop --force-with-lease
```

**결과**:
```
To https://lab.ssafy.com/s13-final/S13P31E107.git
 + 57b837b...4c1b6fe develop -> develop (forced update)
```

**`--force-with-lease` vs `--force`**:
- `--force-with-lease`: 다른 사람이 푸시한 커밋이 있으면 실패 (더 안전)
- `--force`: 무조건 덮어씀 (위험)

---

### 9단계: 최종 검증

```bash
# 히스토리 확인
git log --oneline --graph -10

# 8775b6c 커밋 존재 여부 확인
git log --all --oneline | grep "8775b6c"
# 결과: (출력 없음) ✅

# Redis/PostgreSQL 관련 커밋 확인
git log --all --oneline | grep -i "redis\|postgresql"
# 결과: (출력 없음) ✅
```

---

## 📊 최종 결과

### 성공적으로 제거됨 ✅
- 커밋 `8775b6c` 및 이후 **8개 커밋** 완전 삭제
- `application.yml` 민감정보 히스토리에서 영구 제거
- Git graph에서 완전히 사라짐

### 보존된 변경사항 ✅
- `build.gradle` 의존성 재정렬 → 새 커밋 `4c1b6fe`로 재적용
- `SecondBrainApplication.java` 패키지명 수정 → 새 커밋 `4c1b6fe`로 재적용

### 현재 히스토리
```
* 4c1b6fe [BE] chore: 의존성 재정렬 및 패키지명 수정
* cd23dca [BE] chore: 사용하지 않는 예외처리 삭제
* 29b05f9 [FE] chore: Husky v9 마이그레이션 완료
* c8356f7 [FE] chore: Husky 스크립트 개선 및 .nvmrc 추가
...
```

---

## 🔑 핵심 개념 정리

### Git Reset의 3가지 모드

| 모드 | 작업 디렉토리 | Staging Area | HEAD |
|------|--------------|--------------|------|
| `--soft` | 유지 | 유지 | 이동 |
| `--mixed` (기본) | 유지 | 초기화 | 이동 |
| `--hard` | 초기화 | 초기화 | 이동 |

**이번 작업에서 사용한 이유**:
- `--hard`를 사용하여 커밋을 **완전히 제거**하고 작업 디렉토리도 해당 커밋 상태로 되돌림
- 이후 필요한 변경사항만 패치로 재적용

---

### Git Filter-Repo vs Git Reset

| 도구 | 용도 | 장점 | 단점 |
|------|------|------|------|
| `git-filter-repo` | 특정 **파일** 제거 | 파일별 정밀 제거 | 커밋은 남음, 예측 어려움 |
| `git reset --hard` | 특정 **커밋** 제거 | 커밋 완전 삭제, 명확함 | 이후 모든 커밋 삭제됨 |

**선택 기준**:
- 파일만 히스토리에서 제거하고 커밋은 유지 → `git-filter-repo`
- 커밋 자체를 완전히 삭제 → `git reset --hard`

---

## 🚨 필수 후속 조치

### 1. 패스워드 즉시 변경 (최우선!)

```bash
# PostgreSQL 패스워드 변경
ssh brainsecond.site
psql -U postgres
ALTER USER e107 WITH PASSWORD 'NEW_STRONG_PASSWORD';

# Redis 패스워드 변경
redis-cli
CONFIG SET requirepass "NEW_STRONG_PASSWORD"
CONFIG REWRITE
```

**중요**: Git 히스토리 제거만으로는 불충분! 이미 노출된 패스워드는 반드시 변경해야 함.

---

### 2. 팀원 협업 대응

**팀원들에게 공지**:
```
🚨 중요: Git 히스토리 재작성 완료

보안 이슈로 develop 브랜치의 히스토리를 재작성했습니다.

⚠️ 필수 조치:
1. 현재 작업 중인 내용 커밋 또는 stash
2. git fetch origin
3. git reset --hard origin/develop

문의사항은 연락 주세요.
```

**팀원들이 실행할 명령어**:
```bash
# 작업 중인 내용 백업 (선택)
git branch backup-before-reset

# 원격 최신 상태로 강제 동기화
git fetch origin
git reset --hard origin/develop

# 작업 내용이 있었다면 복구
git checkout backup-before-reset
git rebase develop
```

---

### 3. 보안 설정 강화

#### .gitignore 업데이트

```gitignore
# Spring Boot 설정 파일 (민감정보 포함)
application.yml
application.yaml
application.properties
application-*.yml
application-*.yaml
application-*.properties
```

#### application.yml.example 템플릿 생성

```yaml
spring:
  application:
    name: SecondBrain

  datasource:
    url: jdbc:postgresql://YOUR_HOST:5432/YOUR_DATABASE
    username: YOUR_USERNAME
    password: YOUR_PASSWORD
    driver-class-name: org.postgresql.Driver

  data:
    redis:
      host: YOUR_REDIS_HOST
      port: 6379
      password: YOUR_REDIS_PASSWORD
```

**사용 방법**:
```bash
cp application.yml.example application.yml
# 실제 값으로 수정
```

---

## 💡 배운 점과 교훈

### 1. Git 히스토리는 "삭제"가 아니라 "참조 제거"

Git의 객체 저장소는 불변(immutable)이다. `git reset`이나 `git filter-repo`는 **커밋을 삭제하는 것이 아니라 참조를 제거**하는 것이다.

- 로컬에서는 `git gc --prune`으로 정리
- 원격에서는 Force push로 참조를 덮어씀

### 2. 백업의 중요성

```bash
git bundle create backup.bundle --all
```

이 한 줄이 모든 실수를 복구 가능하게 만든다. Git 히스토리 수정 작업 전에는 **반드시 백업**!

### 3. 민감정보는 처음부터 커밋하지 말 것

**예방이 최선**:
- `.gitignore`에 미리 설정 파일 추가
- 커밋 전 `git diff` 습관화
- Pre-commit hook으로 민감정보 검사

### 4. Force Push의 위험성과 팀 커뮤니케이션

Force push는 강력하지만 위험하다:
- 팀원들에게 **사전 공지 필수**
- 작업 시간대 조율 (오프피크 추천)
- `--force-with-lease` 사용으로 안전성 확보

---

## 🔗 참고 자료

- [Git Reset 공식 문서](https://git-scm.com/docs/git-reset)
- [git-filter-repo GitHub](https://github.com/newren/git-filter-repo)
- [GitHub: Removing sensitive data from a repository](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository)
- [Atlassian Git Tutorials: Rewriting History](https://www.atlassian.com/git/tutorials/rewriting-history)

---

## 📝 체크리스트 (향후 유사 상황 대비)

### 사전 예방
- [ ] `.gitignore`에 민감정보 파일 패턴 추가
- [ ] 템플릿 파일(`.example`) 사용 규칙 수립
- [ ] Pre-commit hook으로 민감정보 검사 자동화
- [ ] 환경 변수 사용으로 설정 분리

### 문제 발생 시
- [ ] 전체 저장소 백업 (`git bundle`)
- [ ] 영향 범위 분석 (커밋 수, 파일 목록)
- [ ] 보존할 변경사항 패치 파일로 백업
- [ ] 팀원들에게 사전 공지

### 히스토리 정리 후
- [ ] 로컬 히스토리 검증
- [ ] Force push 실행
- [ ] 원격 히스토리 검증
- [ ] 노출된 패스워드 즉시 변경
- [ ] 팀원 동기화 지원
- [ ] 보안 설정 강화

---

## 🎓 결론

Git 히스토리에서 민감정보를 제거하는 작업은 단순히 파일을 삭제하는 것과는 완전히 다른 개념이다.

**핵심 포인트**:
1. **백업 필수**: 모든 히스토리 수정 작업 전
2. **도구 선택**: 파일 제거 vs 커밋 제거 목적에 맞게
3. **완전한 정리**: 로컬 + 원격 모두 정리
4. **패스워드 변경**: 히스토리 제거만으로는 불충분
5. **팀 커뮤니케이션**: Force push의 영향 공유

**이번 경험을 통해**:
- Git의 내부 구조(객체 저장소, refs)에 대한 이해가 깊어졌다
- `git reset --hard`와 `git-filter-repo`의 차이를 명확히 알게 되었다
- 민감정보 관리의 중요성과 사전 예방의 필요성을 체감했다

앞으로는 **민감정보가 애초에 커밋되지 않도록** `.gitignore`와 템플릿 파일을 적극 활용할 것이다.

---

**작성일**: 2025-10-29
**소요 시간**: 약 1시간
